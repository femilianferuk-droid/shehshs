#!/usr/bin/env python3
# -*- coding: utf-8 -*-

from flask import Flask, render_template_string, request, redirect, url_for, session, jsonify, send_from_directory
from flask_socketio import SocketIO, emit, join_room, leave_room
import sqlite3
import hashlib
import os
import time
import json
import uuid
from datetime import datetime
import mimetypes
import threading

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Flask
app = Flask(__name__, static_folder='static')
app.config['SECRET_KEY'] = 'monkeygram-secret-key-' + str(uuid.uuid4())
app.config['DATABASE'] = 'monkeygram_web.db'
app.config['UPLOAD_FOLDER'] = 'static/uploads'
app.config['MAX_CONTENT_LENGTH'] = 16 * 1024 * 1024  # 16MB

# –°–æ–∑–¥–∞–µ–º –ø–∞–ø–∫–∏
os.makedirs('static', exist_ok=True)
os.makedirs('static/uploads', exist_ok=True)
os.makedirs('static/uploads/avatars', exist_ok=True)
os.makedirs('static/uploads/files', exist_ok=True)

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è SocketIO
socketio = SocketIO(app, cors_allowed_origins="*")

# HTML —à–∞–±–ª–æ–Ω—ã
BASE_TEMPLATE = '''
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MonkeyGram - {{ title }}</title>
    <style>
        :root {
            --primary: #4a6fa5;
            --secondary: #6b8cbc;
            --success: #28a745;
            --danger: #dc3545;
            --warning: #ffc107;
            --info: #17a2b8;
            --dark: #1a1a2e;
            --light: #f8f9fa;
            --bg-color: #1a1a2e;
            --card-bg: #16213e;
            --text-color: #e6e6e6;
            --border-color: #2d4059;
        }
        
        .light-theme {
            --bg-color: #f5f5f5;
            --card-bg: #ffffff;
            --text-color: #333333;
            --border-color: #dddddd;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* –ù–∞–≤–∏–≥–∞—Ü–∏—è */
        .navbar {
            background-color: var(--card-bg);
            border-bottom: 1px solid var(--border-color);
            padding: 15px 0;
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        
        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .nav-brand {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary);
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .nav-menu {
            display: flex;
            gap: 20px;
            align-items: center;
        }
        
        .nav-menu a {
            color: var(--text-color);
            text-decoration: none;
            padding: 8px 15px;
            border-radius: 5px;
            transition: background-color 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .nav-menu a:hover {
            background-color: var(--primary);
            color: white;
        }
        
        /* –ö–∞—Ä—Ç–æ—á–∫–∏ */
        .card {
            background-color: var(--card-bg);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--border-color);
        }
        
        /* –ö–Ω–æ–ø–∫–∏ */
        .btn {
            display: inline-block;
            padding: 10px 20px;
            background-color: var(--primary);
            color: white;
            text-decoration: none;
            border-radius: 5px;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s;
            font-size: 1rem;
        }
        
        .btn:hover {
            background-color: var(--secondary);
        }
        
        .btn-success {
            background-color: var(--success);
        }
        
        .btn-danger {
            background-color: var(--danger);
        }
        
        /* –§–æ—Ä–º—ã */
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-control {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            background-color: var(--card-bg);
            color: var(--text-color);
            font-size: 1rem;
        }
        
        /* –ß–∞—Ç */
        .chat-container {
            display: flex;
            height: calc(100vh - 150px);
            gap: 20px;
        }
        
        .chat-sidebar {
            width: 300px;
            background-color: var(--card-bg);
            border-radius: 10px;
            padding: 20px;
            overflow-y: auto;
        }
        
        .chat-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: var(--card-bg);
            border-radius: 10px;
            overflow: hidden;
        }
        
        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .message {
            max-width: 70%;
            padding: 10px 15px;
            border-radius: 15px;
        }
        
        .message-sent {
            align-self: flex-end;
            background-color: var(--primary);
            color: white;
        }
        
        .message-received {
            align-self: flex-start;
            background-color: var(--border-color);
        }
        
        /* –°–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤ */
        .chat-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .chat-item {
            padding: 15px;
            border-radius: 10px;
            background-color: rgba(255, 255, 255, 0.05);
            cursor: pointer;
            transition: background-color 0.3s;
            text-decoration: none;
            color: var(--text-color);
        }
        
        .chat-item:hover {
            background-color: var(--primary);
        }
        
        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
        @media (max-width: 768px) {
            .chat-container {
                flex-direction: column;
                height: auto;
            }
            
            .chat-sidebar {
                width: 100%;
                max-height: 300px;
            }
            
            .message {
                max-width: 90%;
            }
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.0/socket.io.min.js"></script>
</head>
<body class="{{ theme }}">
    <nav class="navbar">
        <div class="nav-container">
            <a href="/" class="nav-brand">
                <i class="fas fa-monkey"></i> MonkeyGram
            </a>
            
            {% if 'user_id' in session %}
            <div class="nav-menu">
                <a href="/dashboard"><i class="fas fa-home"></i> –ì–ª–∞–≤–Ω–∞—è</a>
                <a href="/new_chat"><i class="fas fa-plus"></i> –ù–æ–≤—ã–π —á–∞—Ç</a>
                <a href="/search"><i class="fas fa-search"></i> –ü–æ–∏—Å–∫</a>
                <a href="/profile"><i class="fas fa-user"></i> –ü—Ä–æ—Ñ–∏–ª—å</a>
                <a href="/logout"><i class="fas fa-sign-out-alt"></i> –í—ã–π—Ç–∏</a>
            </div>
            {% endif %}
        </div>
    </nav>

    <main class="container">
        {% block content %}{% endblock %}
    </main>

    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let socket = io();
        let currentChatId = null;
        
        // –£—Ç–∏–ª–∏—Ç—ã
        function showNotification(title, message) {
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification(title, { body: message });
            }
        }
        
        // –ó–∞–ø—Ä–æ—Å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        if ('Notification' in window && Notification.permission === 'default') {
            Notification.requestPermission();
        }
        
        // WebSocket –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
        socket.on('connect', function() {
            console.log('Connected to WebSocket server');
        });
        
        socket.on('new_message', function(data) {
            if (currentChatId === data.chat_id) {
                addMessage(data.message);
            }
            showNotification('–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ', data.message.sender_name + ': ' + data.message.text);
        });
        
        socket.on('message_reacted', function(data) {
            if (currentChatId === data.chat_id) {
                updateReactions(data.message_id, data.reaction, data.user_id);
            }
        });
        
        socket.on('user_typing', function(data) {
            if (currentChatId === data.chat_id) {
                showTypingIndicator(data.user_name);
            }
        });
        
        // –§—É–Ω–∫—Ü–∏–∏ —á–∞—Ç–∞
        function joinChat(chatId) {
            if (currentChatId) {
                socket.emit('leave_chat', { chat_id: currentChatId });
            }
            currentChatId = chatId;
            socket.emit('join_chat', { chat_id: chatId });
        }
        
        function sendMessage() {
            if (!currentChatId) return;
            
            const input = document.getElementById('message-input');
            const text = input.value.trim();
            
            if (!text) return;
            
            fetch(`/api/chat/${currentChatId}/send`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ text: text })
            })
            .then(response => response.json())
            .then(data => {
                if (!data.error) {
                    input.value = '';
                }
            });
        }
        
        function sendTyping() {
            if (!currentChatId) return;
            
            fetch(`/api/chat/${currentChatId}/typing`, {
                method: 'POST'
            });
        }
        
        function addMessage(message) {
            const container = document.getElementById('chat-messages');
            if (!container) return;
            
            const messageEl = createMessageElement(message);
            container.appendChild(messageEl);
            container.scrollTop = container.scrollHeight;
        }
        
        function createMessageElement(message) {
            const isSent = message.sender_id === parseInt('{{ user.id if user else 0 }}');
            const className = isSent ? 'message message-sent' : 'message message-received';
            
            return `
                <div class="${className}" data-message-id="${message.id}">
                    <div class="message-header">
                        <strong>${message.sender_name}</strong>
                        <small>${new Date(message.timestamp).toLocaleTimeString()}</small>
                    </div>
                    <div class="message-text">${message.text}</div>
                    <div class="message-actions">
                        <button onclick="reactToMessage(${message.id}, 'üëç')">üëç</button>
                        <button onclick="reactToMessage(${message.id}, '‚ù§Ô∏è')">‚ù§Ô∏è</button>
                        <button onclick="reactToMessage(${message.id}, 'üòÇ')">üòÇ</button>
                    </div>
                </div>
            `;
        }
        
        function reactToMessage(messageId, reaction) {
            fetch(`/api/message/${messageId}/react`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ reaction: reaction })
            });
        }
        
        function showTypingIndicator(userName) {
            const indicator = document.getElementById('typing-indicator');
            if (indicator) {
                indicator.textContent = `${userName} –ø–µ—á–∞—Ç–∞–µ—Ç...`;
                indicator.style.display = 'block';
                setTimeout(() => {
                    indicator.style.display = 'none';
                }, 2000);
            }
        }
        
        function updateReactions(messageId, reaction, userId) {
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ä–µ–∞–∫—Ü–∏–π
            console.log(`User ${userId} reacted with ${reaction} to message ${messageId}`);
        }
        
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –≤—ã–∑–æ–≤—ã
        window.onload = function() {
            if (currentChatId) {
                joinChat(currentChatId);
            }
        };
        
        window.onbeforeunload = function() {
            if (currentChatId) {
                socket.emit('leave_chat', { chat_id: currentChatId });
            }
        };
    </script>
</body>
</html>
'''

INDEX_TEMPLATE = '''
{% extends "base.html" %}
{% block title %}MonkeyGram - –ì–ª–∞–≤–Ω–∞—è{% endblock %}
{% block content %}
<div class="card">
    <h1><i class="fas fa-monkey"></i> MonkeyGram</h1>
    <p>–°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä —Å –¥–≤–æ–π–Ω–æ–π –∑–∞—â–∏—Ç–æ–π –ø–∞—Ä–æ–ª–µ–π</p>
    
    <div style="display: flex; gap: 20px; margin-top: 30px;">
        <a href="/register" class="btn btn-success">
            <i class="fas fa-user-plus"></i> –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
        </a>
        <a href="/login" class="btn">
            <i class="fas fa-sign-in-alt"></i> –í—Ö–æ–¥
        </a>
    </div>
    
    <div style="margin-top: 40px; display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
        <div class="feature">
            <i class="fas fa-shield-alt" style="font-size: 2rem; color: var(--primary);"></i>
            <h3>–î–≤–æ–π–Ω–∞—è –∑–∞—â–∏—Ç–∞</h3>
            <p>–î–≤–∞ –ø–∞—Ä–æ–ª—è –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –∞–∫–∫–∞—É–Ω—Ç–∞</p>
        </div>
        <div class="feature">
            <i class="fas fa-comments" style="font-size: 2rem; color: var(--primary);"></i>
            <h3>–ß–∞—Ç—ã –∏ –≥—Ä—É–ø–ø—ã</h3>
            <p>–ü—Ä–∏–≤–∞—Ç–Ω—ã–µ –±–µ—Å–µ–¥—ã, –≥—Ä—É–ø–ø—ã –∏ –∫–∞–Ω–∞–ª—ã</p>
        </div>
        <div class="feature">
            <i class="fas fa-file-upload" style="font-size: 2rem; color: var(--primary);"></i>
            <h3>–û–±–º–µ–Ω —Ñ–∞–π–ª–∞–º–∏</h3>
            <p>–û—Ç–ø—Ä–∞–≤–ª—è–π—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è, –¥–æ–∫—É–º–µ–Ω—Ç—ã –∏ –¥—Ä—É–≥–∏–µ —Ñ–∞–π–ª—ã</p>
        </div>
        <div class="feature">
            <i class="fas fa-mobile-alt" style="font-size: 2rem; color: var(--primary);"></i>
            <h3>–í–µ–∑–¥–µ –∏ –≤—Å–µ–≥–¥–∞</h3>
            <p>–î–æ—Å—Ç—É–ø —Å –ª—é–±–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ —á–µ—Ä–µ–∑ –±—Ä–∞—É–∑–µ—Ä</p>
        </div>
    </div>
</div>
{% endblock %}
'''

REGISTER_TEMPLATE = '''
{% extends "base.html" %}
{% block title %}MonkeyGram - –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è{% endblock %}
{% block content %}
<div class="card" style="max-width: 500px; margin: 0 auto;">
    <h2><i class="fas fa-user-plus"></i> –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
    
    {% if error %}
    <div style="background-color: var(--danger); color: white; padding: 10px; border-radius: 5px; margin-bottom: 20px;">
        {{ error }}
    </div>
    {% endif %}
    
    <form method="POST" action="/register">
        <div class="form-group">
            <label for="name">–ò–º—è:</label>
            <input type="text" id="name" name="name" class="form-control" required value="{{ name }}">
        </div>
        
        <div class="form-group">
            <label for="username">–Æ–∑–µ—Ä–Ω–µ–π–º:</label>
            <input type="text" id="username" name="username" class="form-control" required value="{{ username }}">
            <small>–¢–æ–ª—å–∫–æ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã –∏ _ (3-20 —Å–∏–º–≤–æ–ª–æ–≤)</small>
        </div>
        
        <div class="form-group">
            <label for="password1">–ü–µ—Ä–≤—ã–π –ø–∞—Ä–æ–ª—å:</label>
            <input type="password" id="password1" name="password1" class="form-control" required>
            <small>–ú–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤</small>
        </div>
        
        <div class="form-group">
            <label for="password2">–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–µ—Ä–≤—ã–π –ø–∞—Ä–æ–ª—å:</label>
            <input type="password" id="password2" name="password2" class="form-control" required>
        </div>
        
        <div class="form-group">
            <label for="password3">–í—Ç–æ—Ä–æ–π –ø–∞—Ä–æ–ª—å (–¥—Ä—É–≥–æ–π!):</label>
            <input type="password" id="password3" name="password3" class="form-control" required>
        </div>
        
        <div class="form-group">
            <label for="password4">–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –≤—Ç–æ—Ä–æ–π –ø–∞—Ä–æ–ª—å:</label>
            <input type="password" id="password4" name="password4" class="form-control" required>
        </div>
        
        <div class="form-group">
            <label for="description">–û–ø–∏—Å–∞–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):</label>
            <textarea id="description" name="description" class="form-control">{{ description }}</textarea>
        </div>
        
        <button type="submit" class="btn btn-success" style="width: 100%;">
            <i class="fas fa-check"></i> –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è
        </button>
    </form>
    
    <div style="margin-top: 20px; text-align: center;">
        <p>–£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? <a href="/login">–í–æ–π—Ç–∏</a></p>
    </div>
</div>
{% endblock %}
'''

LOGIN_TEMPLATE = '''
{% extends "base.html" %}
{% block title %}MonkeyGram - –í—Ö–æ–¥{% endblock %}
{% block content %}
<div class="card" style="max-width: 500px; margin: 0 auto;">
    <h2><i class="fas fa-sign-in-alt"></i> –í—Ö–æ–¥</h2>
    
    {% if error %}
    <div style="background-color: var(--danger); color: white; padding: 10px; border-radius: 5px; margin-bottom: 20px;">
        {{ error }}
    </div>
    {% endif %}
    
    <form method="POST" action="/login">
        <div class="form-group">
            <label for="username">–Æ–∑–µ—Ä–Ω–µ–π–º:</label>
            <input type="text" id="username" name="username" class="form-control" required>
        </div>
        
        <div class="form-group">
            <label for="password1">–ü–µ—Ä–≤—ã–π –ø–∞—Ä–æ–ª—å:</label>
            <input type="password" id="password1" name="password1" class="form-control" required>
        </div>
        
        <div class="form-group">
            <label for="password2">–í—Ç–æ—Ä–æ–π –ø–∞—Ä–æ–ª—å:</label>
            <input type="password" id="password2" name="password2" class="form-control" required>
        </div>
        
        <button type="submit" class="btn" style="width: 100%;">
            <i class="fas fa-sign-in-alt"></i> –í–æ–π—Ç–∏
        </button>
    </form>
    
    <div style="margin-top: 20px; text-align: center;">
        <p>–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? <a href="/register">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</a></p>
    </div>
</div>
{% endblock %}
'''

DASHBOARD_TEMPLATE = '''
{% extends "base.html" %}
{% block title %}MonkeyGram - –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è{% endblock %}
{% block content %}
<div class="dashboard">
    <div class="card">
        <h2>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, {{ user.name }}! <span style="color: var(--success);">üêµ</span></h2>
        <p>–Æ–∑–µ—Ä–Ω–µ–π–º: <strong>@{{ user.username }}</strong></p>
        <p>–°—Ç–∞—Ç—É—Å: <span style="color: var(--success);">üü¢ –û–Ω–ª–∞–π–Ω</span></p>
    </div>
    
    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-top: 20px;">
        <div class="card">
            <h3><i class="fas fa-comments"></i> –ú–æ–∏ —á–∞—Ç—ã</h3>
            <div class="chat-list">
                {% for chat in chats %}
                <a href="/chat/{{ chat.id }}" class="chat-item">
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <div style="width: 40px; height: 40px; border-radius: 50%; background-color: var(--primary); 
                                 display: flex; align-items: center; justify-content: center; color: white;">
                            {% if chat.type == 'private' %}
                            <i class="fas fa-user"></i>
                            {% elif chat.type == 'group' %}
                            <i class="fas fa-users"></i>
                            {% else %}
                            <i class="fas fa-bullhorn"></i>
                            {% endif %}
                        </div>
                        <div>
                            <div style="font-weight: bold;">{{ chat.display_name }}</div>
                            <div style="font-size: 0.9em; opacity: 0.8;">
                                {% if chat.type == 'private' %}
                                –ü—Ä–∏–≤–∞—Ç–Ω—ã–π —á–∞—Ç
                                {% else %}
                                {{ chat.type == 'group' and '–ì—Ä—É–ø–ø–∞' or '–ö–∞–Ω–∞–ª' }}
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </a>
                {% else %}
                <p style="text-align: center; padding: 20px; opacity: 0.7;">
                    –£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç —á–∞—Ç–æ–≤
                </p>
                {% endfor %}
            </div>
            <a href="/new_chat" class="btn" style="margin-top: 15px; display: block; text-align: center;">
                <i class="fas fa-plus"></i> –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π —á–∞—Ç
            </a>
        </div>
        
        <div class="card">
            <h3><i class="fas fa-bolt"></i> –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</h3>
            <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 15px;">
                <a href="/search" class="btn">
                    <i class="fas fa-search"></i> –ü–æ–∏—Å–∫ –ª—é–¥–µ–π
                </a>
                <a href="/profile" class="btn">
                    <i class="fas fa-user-edit"></i> –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å
                </a>
                <a href="/new_chat?type=group" class="btn">
                    <i class="fas fa-users"></i> –°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É
                </a>
                <a href="/new_chat?type=channel" class="btn">
                    <i class="fas fa-bullhorn"></i> –°–æ–∑–¥–∞—Ç—å –∫–∞–Ω–∞–ª
                </a>
            </div>
            
            <h3 style="margin-top: 30px;"><i class="fas fa-info-circle"></i> –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
            <div style="margin-top: 15px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <div style="text-align: center;">
                    <div style="font-size: 1.5em; font-weight: bold; color: var(--primary);">{{ chats|length }}</div>
                    <div>–ß–∞—Ç–æ–≤</div>
                </div>
                <div style="text-align: center;">
                    <div style="font-size: 1.5em; font-weight: bold; color: var(--success);">24</div>
                    <div>–ß–∞—Å–æ–≤ –æ–Ω–ª–∞–π–Ω</div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
'''

CHAT_TEMPLATE = '''
{% extends "base.html" %}
{% block title %}MonkeyGram - {{ chat.display_name or chat.name }}{% endblock %}
{% block content %}
<div class="chat-container">
    <div class="chat-sidebar">
        <div class="chat-info">
            <h3>{{ chat.display_name or chat.name }}</h3>
            <p>
                {% if chat.type == 'private' %}
                <i class="fas fa-user"></i> –ü—Ä–∏–≤–∞—Ç–Ω—ã–π —á–∞—Ç
                {% elif chat.type == 'group' %}
                <i class="fas fa-users"></i> –ì—Ä—É–ø–ø–∞
                {% else %}
                <i class="fas fa-bullhorn"></i> –ö–∞–Ω–∞–ª
                {% endif %}
            </p>
        </div>
        
        <div style="margin-top: 20px;">
            <h4>–£—á–∞—Å—Ç–Ω–∏–∫–∏ ({{ members|length }})</h4>
            <div style="margin-top: 10px; display: flex; flex-direction: column; gap: 10px;">
                {% for member in members %}
                <div style="display: flex; align-items: center; gap: 10px; padding: 8px; border-radius: 5px; background-color: rgba(255,255,255,0.05);">
                    <div style="width: 30px; height: 30px; border-radius: 50%; background-color: var(--primary); 
                             display: flex; align-items: center; justify-content: center; color: white; font-size: 0.8em;">
                        {{ member.name[0]|upper }}
                    </div>
                    <div>
                        <div style="font-weight: bold;">{{ member.name }}</div>
                        <div style="font-size: 0.8em; opacity: 0.7;">
                            {% if member.role == 'creator' %}
                            –°–æ–∑–¥–∞—Ç–µ–ª—å
                            {% elif member.role == 'admin' %}
                            –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä
                            {% else %}
                            –£—á–∞—Å—Ç–Ω–∏–∫
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    
    <div class="chat-main">
        <div class="chat-header" style="padding: 15px; background-color: var(--primary); color: white;">
            <h3>{{ chat.display_name or chat.name }}</h3>
            <div id="typing-indicator" style="font-size: 0.9em; opacity: 0.8; display: none;"></div>
        </div>
        
        <div class="chat-messages" id="chat-messages">
            {% for message in messages %}
            <div class="message {% if message.sender_id == user.id %}message-sent{% else %}message-received{% endif %}" 
                 data-message-id="{{ message.id }}">
                <div style="display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 0.9em; opacity: 0.8;">
                    <span>{{ message.sender_name }}</span>
                    <span>{{ message.timestamp }}</span>
                </div>
                <div>{{ message.text }}</div>
                <div style="margin-top: 5px; display: flex; gap: 5px;">
                    <button onclick="reactToMessage({{ message.id }}, 'üëç')" style="background: none; border: none; cursor: pointer; font-size: 1.2em;">üëç</button>
                    <button onclick="reactToMessage({{ message.id }}, '‚ù§Ô∏è')" style="background: none; border: none; cursor: pointer; font-size: 1.2em;">‚ù§Ô∏è</button>
                    <button onclick="reactToMessage({{ message.id }}, 'üòÇ')" style="background: none; border: none; cursor: pointer; font-size: 1.2em;">üòÇ</button>
                </div>
            </div>
            {% endfor %}
        </div>
        
        <div style="padding: 15px; border-top: 1px solid var(--border-color);">
            <div style="display: flex; gap: 10px;">
                <input type="text" id="message-input" class="form-control" 
                       placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." 
                       onkeydown="if(event.key === 'Enter') sendMessage()"
                       oninput="sendTyping()">
                <button onclick="sendMessage()" class="btn">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
            <div style="margin-top: 10px; font-size: 0.9em; opacity: 0.7;">
                –ù–∞–∂–º–∏—Ç–µ Enter –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
            </div>
        </div>
    </div>
</div>

<script>
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —á–∞—Ç–∞
    currentChatId = {{ chat.id }};
    joinChat(currentChatId);
    
    // –ê–≤—Ç–æ–ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –∫ –ø–æ—Å–ª–µ–¥–Ω–∏–º —Å–æ–æ–±—â–µ–Ω–∏—è–º
    window.onload = function() {
        const container = document.getElementById('chat-messages');
        if (container) {
            container.scrollTop = container.scrollHeight;
        }
    };
</script>
{% endblock %}
'''

PROFILE_TEMPLATE = '''
{% extends "base.html" %}
{% block title %}MonkeyGram - –ü—Ä–æ—Ñ–∏–ª—å{% endblock %}
{% block content %}
<div class="card" style="max-width: 600px; margin: 0 auto;">
    <div style="text-align: center; margin-bottom: 30px;">
        <div style="width: 150px; height: 150px; border-radius: 50%; background-color: var(--primary); 
                 margin: 0 auto 20px; display: flex; align-items: center; justify-content: center; color: white; font-size: 3em;">
            {{ user.name[0]|upper }}
        </div>
        <h2>{{ user.name }}</h2>
        <p style="color: var(--secondary); font-size: 1.2em;">@{{ user.username }}</p>
        {% if user.description %}
        <p style="margin-top: 10px; font-style: italic;">"{{ user.description }}"</p>
        {% endif %}
    </div>
    
    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; text-align: center; margin-bottom: 30px;">
        <div>
            <div style="font-size: 1.5em; font-weight: bold; color: var(--primary);">{{ chats_count }}</div>
            <div>–ß–∞—Ç–æ–≤</div>
        </div>
        <div>
            <div style="font-size: 1.5em; font-weight: bold; color: var(--success);">24</div>
            <div>–ß–∞—Å–æ–≤ –æ–Ω–ª–∞–π–Ω</div>
        </div>
        <div>
            <div style="font-size: 1.5em; font-weight: bold; color: var(--info);">{{ days_active }}</div>
            <div>–î–Ω–µ–π –≤ —Å–µ—Ç–∏</div>
        </div>
    </div>
    
    <div style="background-color: rgba(255,255,255,0.05); padding: 15px; border-radius: 10px; margin-bottom: 20px;">
        <h4><i class="fas fa-info-circle"></i> –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h4>
        <div style="margin-top: 10px;">
            <p><strong>–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω:</strong> {{ user.created_at[:10] }}</p>
            <p><strong>–ü–æ—Å–ª–µ–¥–Ω–∏–π –≤—Ö–æ–¥:</strong> {{ user.last_seen[:19] }}</p>
            <p><strong>–°—Ç–∞—Ç—É—Å:</strong> <span style="color: var(--success);">üü¢ –û–Ω–ª–∞–π–Ω</span></p>
        </div>
    </div>
    
    <div style="display: flex; gap: 10px; justify-content: center;">
        <a href="/edit_profile" class="btn">
            <i class="fas fa-edit"></i> –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å
        </a>
        <a href="/dashboard" class="btn">
            <i class="fas fa-arrow-left"></i> –ù–∞–∑–∞–¥
        </a>
    </div>
</div>
{% endblock %}
'''

NEW_CHAT_TEMPLATE = '''
{% extends "base.html" %}
{% block title %}MonkeyGram - –ù–æ–≤—ã–π —á–∞—Ç{% endblock %}
{% block content %}
<div class="card" style="max-width: 500px; margin: 0 auto;">
    <h2><i class="fas fa-plus-circle"></i> –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π —á–∞—Ç</h2>
    
    {% if error %}
    <div style="background-color: var(--danger); color: white; padding: 10px; border-radius: 5px; margin-bottom: 20px;">
        {{ error }}
    </div>
    {% endif %}
    
    <form method="POST" action="/new_chat">
        <div class="form-group">
            <label for="type">–¢–∏–ø —á–∞—Ç–∞:</label>
            <select id="type" name="type" class="form-control" onchange="toggleFields()">
                <option value="private" {% if type == 'private' %}selected{% endif %}>–ü—Ä–∏–≤–∞—Ç–Ω—ã–π —á–∞—Ç</option>
                <option value="group" {% if type == 'group' %}selected{% endif %}>–ì—Ä—É–ø–ø–∞</option>
                <option value="channel" {% if type == 'channel' %}selected{% endif %}>–ö–∞–Ω–∞–ª</option>
            </select>
        </div>
        
        <div class="form-group" id="name-field" {% if type == 'private' %}style="display: none;"{% endif %}>
            <label for="name">–ù–∞–∑–≤–∞–Ω–∏–µ:</label>
            <input type="text" id="name" name="name" class="form-control" value="{{ name }}">
        </div>
        
        <div class="form-group" id="partner-field" {% if type != 'private' %}style="display: none;"{% endif %}>
            <label for="partner_username">–Æ–∑–µ—Ä–Ω–µ–π–º —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞:</label>
            <input type="text" id="partner_username" name="partner_username" class="form-control" value="{{ partner_username }}">
        </div>
        
        <div class="form-group">
            <label for="description">–û–ø–∏—Å–∞–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):</label>
            <textarea id="description" name="description" class="form-control">{{ description }}</textarea>
        </div>
        
        <button type="submit" class="btn" style="width: 100%;">
            <i class="fas fa-check"></i> –°–æ–∑–¥–∞—Ç—å —á–∞—Ç
        </button>
    </form>
    
    <a href="/dashboard" class="btn" style="width: 100%; margin-top: 10px;">
        <i class="fas fa-arrow-left"></i> –ù–∞–∑–∞–¥
    </a>
</div>

<script>
    function toggleFields() {
        const type = document.getElementById('type').value;
        const nameField = document.getElementById('name-field');
        const partnerField = document.getElementById('partner-field');
        
        if (type === 'private') {
            nameField.style.display = 'none';
            partnerField.style.display = 'block';
        } else {
            nameField.style.display = 'block';
            partnerField.style.display = 'none';
        }
    }
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    window.onload = function() {
        toggleFields();
    };
</script>
{% endblock %}
'''

SEARCH_TEMPLATE = '''
{% extends "base.html" %}
{% block title %}MonkeyGram - –ü–æ–∏—Å–∫{% endblock %}
{% block content %}
<div class="card">
    <h2><i class="fas fa-search"></i> –ü–æ–∏—Å–∫</h2>
    
    <form method="GET" action="/search" style="margin-bottom: 20px;">
        <div style="display: flex; gap: 10px;">
            <input type="text" name="q" class="form-control" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è –∏–ª–∏ —é–∑–µ—Ä–Ω–µ–π–º..." value="{{ query }}">
            <button type="submit" class="btn">
                <i class="fas fa-search"></i> –ü–æ–∏—Å–∫
            </button>
        </div>
    </form>
    
    {% if query %}
        {% if users %}
        <h3>–ù–∞–π–¥–µ–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏:</h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px; margin-top: 15px;">
            {% for user in users %}
            <div style="background-color: rgba(255,255,255,0.05); padding: 15px; border-radius: 10px;">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <div style="width: 50px; height: 50px; border-radius: 50%; background-color: var(--primary); 
                             display: flex; align-items: center; justify-content: center; color: white; font-size: 1.2em;">
                        {{ user.name[0]|upper }}
                    </div>
                    <div>
                        <div style="font-weight: bold;">{{ user.name }}</div>
                        <div style="color: var(--secondary);">@{{ user.username }}</div>
                        {% if user.status_text %}
                        <div style="font-size: 0.9em; opacity: 0.8;">{{ user.status_text }}</div>
                        {% endif %}
                    </div>
                </div>
                <div style="margin-top: 15px; display: flex; gap: 10px;">
                    <a href="/new_chat?partner_username={{ user.username }}" class="btn" style="flex: 1;">
                        <i class="fas fa-comment"></i> –ù–∞–ø–∏—Å–∞—Ç—å
                    </a>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p style="text-align: center; padding: 20px; opacity: 0.7;">
            –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã
        </p>
        {% endif %}
    {% else %}
    <p style="text-align: center; padding: 20px; opacity: 0.7;">
        –í–≤–µ–¥–∏—Ç–µ –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –¥–ª—è –Ω–∞—á–∞–ª–∞ –ø–æ–∏—Å–∫–∞
    </p>
    {% endif %}
</div>

<div style="margin-top: 20px;">
    <a href="/dashboard" class="btn">
        <i class="fas fa-arrow-left"></i> –ù–∞–∑–∞–¥ –≤ –ø–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
    </a>
</div>
{% endblock %}
'''

# ==================== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ====================

def get_db():
    """–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö"""
    db = sqlite3.connect(app.config['DATABASE'])
    db.row_factory = sqlite3.Row
    return db

def init_db():
    """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö"""
    with app.app_context():
        db = get_db()
        
        # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
        db.execute('''
            CREATE TABLE IF NOT EXISTS users (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                name TEXT NOT NULL,
                description TEXT DEFAULT '',
                username TEXT UNIQUE NOT NULL,
                password1 TEXT NOT NULL,
                password2 TEXT NOT NULL,
                last_seen TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                status TEXT DEFAULT 'online',
                status_text TEXT DEFAULT '',
                is_online BOOLEAN DEFAULT 0,
                theme TEXT DEFAULT 'dark'
            )
        ''')
        
        # –ß–∞—Ç—ã
        db.execute('''
            CREATE TABLE IF NOT EXISTS chats (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                type TEXT NOT NULL,
                name TEXT,
                description TEXT DEFAULT '',
                created_by INTEGER,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                FOREIGN KEY (created_by) REFERENCES users(id)
            )
        ''')
        
        # –£—á–∞—Å—Ç–Ω–∏–∫–∏ —á–∞—Ç–æ–≤
        db.execute('''
            CREATE TABLE IF NOT EXISTS chat_members (
                chat_id INTEGER,
                user_id INTEGER,
                role TEXT DEFAULT 'member',
                joined_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                PRIMARY KEY (chat_id, user_id),
                FOREIGN KEY (chat_id) REFERENCES chats(id),
                FOREIGN KEY (user_id) REFERENCES users(id)
            )
        ''')
        
        # –°–æ–æ–±—â–µ–Ω–∏—è
        db.execute('''
            CREATE TABLE IF NOT EXISTS messages (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                chat_id INTEGER NOT NULL,
                sender_id INTEGER NOT NULL,
                text TEXT NOT NULL,
                is_edited BOOLEAN DEFAULT 0,
                edited_at TIMESTAMP,
                reply_to_id INTEGER,
                forwarded_from INTEGER,
                forwarded_from_user INTEGER,
                is_pinned BOOLEAN DEFAULT 0,
                timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                FOREIGN KEY (chat_id) REFERENCES chats(id),
                FOREIGN KEY (sender_id) REFERENCES users(id),
                FOREIGN KEY (reply_to_id) REFERENCES messages(id),
                FOREIGN KEY (forwarded_from_user) REFERENCES users(id)
            )
        ''')
        
        # –†–µ–∞–∫—Ü–∏–∏
        db.execute('''
            CREATE TABLE IF NOT EXISTS message_reactions (
                message_id INTEGER,
                user_id INTEGER,
                reaction TEXT NOT NULL,
                timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                PRIMARY KEY (message_id, user_id),
                FOREIGN KEY (message_id) REFERENCES messages(id),
                FOREIGN KEY (user_id) REFERENCES users(id)
            )
        ''')
        
        # –ü—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
        db.execute('''
            CREATE TABLE IF NOT EXISTS message_reads (
                message_id INTEGER,
                user_id INTEGER,
                read_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                PRIMARY KEY (message_id, user_id),
                FOREIGN KEY (message_id) REFERENCES messages(id),
                FOREIGN KEY (user_id) REFERENCES users(id)
            )
        ''')
        
        db.commit()
        db.close()

def hash_password(password):
    """–•–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Ä–æ–ª—è"""
    return hashlib.sha256(password.encode()).hexdigest()

def get_user_by_id(user_id):
    """–ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ ID"""
    db = get_db()
    user = db.execute('SELECT * FROM users WHERE id = ?', (user_id,)).fetchone()
    db.close()
    return dict(user) if user else None

def update_user_online(user_id, is_online=True):
    """–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –æ–Ω–ª–∞–π–Ω"""
    db = get_db()
    db.execute('UPDATE users SET is_online = ?, last_seen = CURRENT_TIMESTAMP WHERE id = ?',
               (1 if is_online else 0, user_id))
    db.commit()
    db.close()

# ==================== –†–û–£–¢–´ ====================

@app.route('/')
def index():
    """–ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞"""
    if 'user_id' in session:
        return redirect('/dashboard')
    return render_template_string(BASE_TEMPLATE, 
                                content=render_template_string(INDEX_TEMPLATE),
                                title='–ì–ª–∞–≤–Ω–∞—è',
                                theme='dark')

@app.route('/register', methods=['GET', 'POST'])
def register():
    """–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è"""
    if 'user_id' in session:
        return redirect('/dashboard')
    
    if request.method == 'POST':
        name = request.form.get('name', '').strip()
        username = request.form.get('username', '').strip()
        password1 = request.form.get('password1', '')
        password2 = request.form.get('password2', '')
        password3 = request.form.get('password3', '')
        password4 = request.form.get('password4', '')
        description = request.form.get('description', '').strip()
        
        # –í–∞–ª–∏–¥–∞—Ü–∏—è
        errors = []
        if not name:
            errors.append('–ò–º—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ')
        if not username or len(username) < 3:
            errors.append('–Æ–∑–µ—Ä–Ω–µ–π–º –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –º–µ–Ω–µ–µ 3 —Å–∏–º–≤–æ–ª–æ–≤')
        if len(password1) < 6:
            errors.append('–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –º–µ–Ω–µ–µ 6 —Å–∏–º–≤–æ–ª–æ–≤')
        if password1 != password2:
            errors.append('–ü–µ—Ä–≤—ã–π –ø–∞—Ä–æ–ª—å –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç')
        if password3 != password4:
            errors.append('–í—Ç–æ—Ä–æ–π –ø–∞—Ä–æ–ª—å –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç')
        if password1 == password3:
            errors.append('–í—Ç–æ—Ä–æ–π –ø–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –æ—Ç–ª–∏—á–∞—Ç—å—Å—è –æ—Ç –ø–µ—Ä–≤–æ–≥–æ')
        
        if errors:
            return render_template_string(BASE_TEMPLATE,
                                        content=render_template_string(REGISTER_TEMPLATE, 
                                                                      error=' | '.join(errors),
                                                                      name=name,
                                                                      username=username,
                                                                      description=description),
                                        title='–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è',
                                        theme='dark')
        
        db = get_db()
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏
        if db.execute('SELECT id FROM users WHERE username = ?', (username,)).fetchone():
            db.close()
            return render_template_string(BASE_TEMPLATE,
                                        content=render_template_string(REGISTER_TEMPLATE,
                                                                      error='–Æ–∑–µ—Ä–Ω–µ–π–º —É–∂–µ –∑–∞–Ω—è—Ç',
                                                                      name=name,
                                                                      username=username,
                                                                      description=description),
                                        title='–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è',
                                        theme='dark')
        
        try:
            # –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            hashed_pw1 = hash_password(password1)
            hashed_pw2 = hash_password(password3)
            
            cursor = db.execute('''
                INSERT INTO users (name, username, description, password1, password2)
                VALUES (?, ?, ?, ?, ?)
            ''', (name, username, description, hashed_pw1, hashed_pw2))
            
            user_id = cursor.lastrowid
            
            # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—Ö–æ–¥
            session['user_id'] = user_id
            update_user_online(user_id)
            
            db.commit()
            db.close()
            
            return redirect('/dashboard')
            
        except Exception as e:
            db.rollback()
            db.close()
            return render_template_string(BASE_TEMPLATE,
                                        content=render_template_string(REGISTER_TEMPLATE,
                                                                      error=f'–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: {str(e)}',
                                                                      name=name,
                                                                      username=username,
                                                                      description=description),
                                        title='–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è',
                                        theme='dark')
    
    return render_template_string(BASE_TEMPLATE,
                                content=render_template_string(REGISTER_TEMPLATE),
                                title='–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è',
                                theme='dark')

@app.route('/login', methods=['GET', 'POST'])
def login():
    """–í—Ö–æ–¥"""
    if 'user_id' in session:
        return redirect('/dashboard')
    
    if request.method == 'POST':
        username = request.form.get('username', '').strip()
        password1 = request.form.get('password1', '')
        password2 = request.form.get('password2', '')
        
        if not username or not password1 or not password2:
            return render_template_string(BASE_TEMPLATE,
                                        content=render_template_string(LOGIN_TEMPLATE,
                                                                      error='–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è'),
                                        title='–í—Ö–æ–¥',
                                        theme='dark')
        
        db = get_db()
        
        # –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        user = db.execute('SELECT * FROM users WHERE username = ?', (username,)).fetchone()
        if not user:
            db.close()
            return render_template_string(BASE_TEMPLATE,
                                        content=render_template_string(LOGIN_TEMPLATE,
                                                                      error='–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω'),
                                        title='–í—Ö–æ–¥',
                                        theme='dark')
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞—Ä–æ–ª–µ–π
        hashed_pw1 = hash_password(password1)
        hashed_pw2 = hash_password(password2)
        
        if user['password1'] != hashed_pw1 or user['password2'] != hashed_pw2:
            db.close()
            return render_template_string(BASE_TEMPLATE,
                                        content=render_template_string(LOGIN_TEMPLATE,
                                                                      error='–ù–µ–≤–µ—Ä–Ω—ã–µ –ø–∞—Ä–æ–ª–∏'),
                                        title='–í—Ö–æ–¥',
                                        theme='dark')
        
        # –£—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥
        session['user_id'] = user['id']
        update_user_online(user['id'])
        
        db.close()
        return redirect('/dashboard')
    
    return render_template_string(BASE_TEMPLATE,
                                content=render_template_string(LOGIN_TEMPLATE),
                                title='–í—Ö–æ–¥',
                                theme='dark')

@app.route('/dashboard')
def dashboard():
    """–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è"""
    if 'user_id' not in session:
        return redirect('/login')
    
    user_id = session['user_id']
    db = get_db()
    
    # –ü–æ–ª—É—á–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    user = dict(db.execute('SELECT * FROM users WHERE id = ?', (user_id,)).fetchone())
    
    # –ü–æ–ª—É—á–∞–µ–º —á–∞—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    chats = db.execute('''
        SELECT c.*, cm.role,
               CASE 
                   WHEN c.type = 'private' THEN (
                       SELECT u.name 
                       FROM users u
                       JOIN chat_members cm2 ON u.id = cm2.user_id
                       WHERE cm2.chat_id = c.id AND u.id != ?
                   )
                   ELSE c.name
               END as display_name
        FROM chats c
        JOIN chat_members cm ON c.id = cm.chat_id
        WHERE cm.user_id = ?
        ORDER BY (
            SELECT MAX(timestamp) 
            FROM messages 
            WHERE chat_id = c.id
        ) DESC
        LIMIT 20
    ''', (user_id, user_id)).fetchall()
    
    db.close()
    
    return render_template_string(BASE_TEMPLATE,
                                content=render_template_string(DASHBOARD_TEMPLATE,
                                                              user=user,
                                                              chats=[dict(chat) for chat in chats]),
                                title='–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è',
                                theme=user.get('theme', 'dark'))

@app.route('/chat/<int:chat_id>')
def chat(chat_id):
    """–°—Ç—Ä–∞–Ω–∏—Ü–∞ —á–∞—Ç–∞"""
    if 'user_id' not in session:
        return redirect('/login')
    
    user_id = session['user_id']
    db = get_db()
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É—á–∞—Å—Ç–Ω–∏–∫–æ–º —á–∞—Ç–∞
    member = db.execute('SELECT * FROM chat_members WHERE chat_id = ? AND user_id = ?', 
                       (chat_id, user_id)).fetchone()
    if not member:
        db.close()
        return redirect('/dashboard')
    
    # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —á–∞—Ç–µ
    chat_info = db.execute('SELECT * FROM chats WHERE id = ?', (chat_id,)).fetchone()
    if not chat_info:
        db.close()
        return redirect('/dashboard')
    
    # –ü–æ–ª—É—á–∞–µ–º —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ —á–∞—Ç–∞
    members = db.execute('''
        SELECT u.*, cm.role
        FROM users u
        JOIN chat_members cm ON u.id = cm.user_id
        WHERE cm.chat_id = ?
        ORDER BY cm.role DESC, u.name ASC
    ''', (chat_id,)).fetchall()
    
    # –ü–æ–ª—É—á–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è
    messages = db.execute('''
        SELECT m.*, 
               u.name as sender_name, 
               u.username as sender_username
        FROM messages m
        JOIN users u ON m.sender_id = u.id
        WHERE m.chat_id = ?
        ORDER BY m.timestamp ASC
        LIMIT 100
    ''', (chat_id,)).fetchall()
    
    # –ü–æ–º–µ—á–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ
    db.execute('''
        INSERT OR IGNORE INTO message_reads (message_id, user_id)
        SELECT m.id, ?
        FROM messages m
        WHERE m.chat_id = ? 
        AND m.id NOT IN (
            SELECT mr.message_id 
            FROM message_reads mr 
            WHERE mr.user_id = ?
        )
    ''', (user_id, chat_id, user_id))
    
    db.commit()
    db.close()
    
    user = get_user_by_id(user_id)
    
    return render_template_string(BASE_TEMPLATE,
                                content=render_template_string(CHAT_TEMPLATE,
                                                              chat=dict(chat_info),
                                                              members=[dict(member) for member in members],
                                                              messages=[dict(msg) for msg in messages],
                                                              user=user),
                                title=chat_info['display_name'] or chat_info['name'],
                                theme=user.get('theme', 'dark'))

@app.route('/profile')
def profile():
    """–ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    if 'user_id' not in session:
        return redirect('/login')
    
    user_id = session['user_id']
    db = get_db()
    
    user = dict(db.execute('SELECT * FROM users WHERE id = ?', (user_id,)).fetchone())
    
    # –°—á–∏—Ç–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —á–∞—Ç–æ–≤
    chats_count = db.execute('SELECT COUNT(*) as count FROM chat_members WHERE user_id = ?', 
                            (user_id,)).fetchone()['count']
    
    # –î–Ω–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ (–ø—Ä–∏–º–µ—Ä–Ω–æ)
    created = datetime.strptime(user['created_at'][:10], '%Y-%m-%d')
    days_active = (datetime.now() - created).days
    
    db.close()
    
    return render_template_string(BASE_TEMPLATE,
                                content=render_template_string(PROFILE_TEMPLATE,
                                                              user=user,
                                                              chats_count=chats_count,
                                                              days_active=days_active),
                                title='–ü—Ä–æ—Ñ–∏–ª—å',
                                theme=user.get('theme', 'dark'))

@app.route('/new_chat', methods=['GET', 'POST'])
def new_chat():
    """–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —á–∞—Ç–∞"""
    if 'user_id' not in session:
        return redirect('/login')
    
    user_id = session['user_id']
    
    if request.method == 'POST':
        chat_type = request.form.get('type', 'private')
        name = request.form.get('name', '').strip()
        partner_username = request.form.get('partner_username', '').strip()
        description = request.form.get('description', '').strip()
        
        if chat_type in ['group', 'channel'] and not name:
            return render_template_string(BASE_TEMPLATE,
                                        content=render_template_string(NEW_CHAT_TEMPLATE,
                                                                      error='–ù–∞–∑–≤–∞–Ω–∏–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è –≥—Ä—É–ø–ø –∏ –∫–∞–Ω–∞–ª–æ–≤',
                                                                      type=chat_type,
                                                                      name=name,
                                                                      partner_username=partner_username,
                                                                      description=description),
                                        title='–ù–æ–≤—ã–π —á–∞—Ç',
                                        theme='dark')
        
        db = get_db()
        
        try:
            # –°–æ–∑–¥–∞–µ–º —á–∞—Ç
            cursor = db.execute('''
                INSERT INTO chats (type, name, description, created_by)
                VALUES (?, ?, ?, ?)
            ''', (chat_type, name, description, user_id))
            
            chat_id = cursor.lastrowid
            
            # –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–∑–¥–∞—Ç–µ–ª—è –≤ —á–∞—Ç
            role = 'creator' if chat_type in ['group', 'channel'] else 'member'
            db.execute('INSERT INTO chat_members (chat_id, user_id, role) VALUES (?, ?, ?)', 
                      (chat_id, user_id, role))
            
            # –ï—Å–ª–∏ —ç—Ç–æ –ø—Ä–∏–≤–∞—Ç–Ω—ã–π —á–∞—Ç, –¥–æ–±–∞–≤–ª—è–µ–º –≤—Ç–æ—Ä–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞
            if chat_type == 'private' and partner_username:
                partner = db.execute('SELECT id FROM users WHERE username = ?', (partner_username,)).fetchone()
                if partner:
                    db.execute('INSERT INTO chat_members (chat_id, user_id) VALUES (?, ?)', 
                              (chat_id, partner['id']))
                else:
                    db.rollback()
                    db.close()
                    return render_template_string(BASE_TEMPLATE,
                                                content=render_template_string(NEW_CHAT_TEMPLATE,
                                                                              error='–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω',
                                                                              type=chat_type,
                                                                              name=name,
                                                                              partner_username=partner_username,
                                                                              description=description),
                                                title='–ù–æ–≤—ã–π —á–∞—Ç',
                                                theme='dark')
            
            db.commit()
            db.close()
            return redirect(f'/chat/{chat_id}')
            
        except Exception as e:
            db.rollback()
            db.close()
            return render_template_string(BASE_TEMPLATE,
                                        content=render_template_string(NEW_CHAT_TEMPLATE,
                                                                      error=f'–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —á–∞—Ç–∞: {str(e)}',
                                                                      type=chat_type,
                                                                      name=name,
                                                                      partner_username=partner_username,
                                                                      description=description),
                                        title='–ù–æ–≤—ã–π —á–∞—Ç',
                                        theme='dark')
    
    # GET –∑–∞–ø—Ä–æ—Å
    chat_type = request.args.get('type', 'private')
    user = get_user_by_id(user_id)
    
    return render_template_string(BASE_TEMPLATE,
                                content=render_template_string(NEW_CHAT_TEMPLATE,
                                                              type=chat_type),
                                title='–ù–æ–≤—ã–π —á–∞—Ç',
                                theme=user.get('theme', 'dark'))

@app.route('/search')
def search():
    """–ü–æ–∏—Å–∫"""
    if 'user_id' not in session:
        return redirect('/login')
    
    query = request.args.get('q', '').strip()
    user_id = session['user_id']
    user = get_user_by_id(user_id)
    
    if not query:
        return render_template_string(BASE_TEMPLATE,
                                    content=render_template_string(SEARCH_TEMPLATE,
                                                                  query=query),
                                    title='–ü–æ–∏—Å–∫',
                                    theme=user.get('theme', 'dark'))
    
    db = get_db()
    
    # –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    users = db.execute('''
        SELECT id, name, username, status_text
        FROM users 
        WHERE (name LIKE ? OR username LIKE ?) AND id != ?
        LIMIT 20
    ''', (f'%{query}%', f'%{query}%', user_id)).fetchall()
    
    db.close()
    
    return render_template_string(BASE_TEMPLATE,
                                content=render_template_string(SEARCH_TEMPLATE,
                                                              query=query,
                                                              users=[dict(user) for user in users]),
                                title='–ü–æ–∏—Å–∫',
                                theme=user.get('theme', 'dark'))

@app.route('/edit_profile')
def edit_profile():
    """–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è"""
    if 'user_id' not in session:
        return redirect('/login')
    
    user_id = session['user_id']
    user = get_user_by_id(user_id)
    
    # –ü—Ä–æ—Å—Ç–æ–π —à–∞–±–ª–æ–Ω –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    edit_template = '''
    <div class="card" style="max-width: 500px; margin: 0 auto;">
        <h2><i class="fas fa-edit"></i> –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è</h2>
        <form method="POST" action="/api/update_profile">
            <div class="form-group">
                <label>–ò–º—è:</label>
                <input type="text" name="name" class="form-control" value="{{ user.name }}">
            </div>
            <div class="form-group">
                <label>–û–ø–∏—Å–∞–Ω–∏–µ:</label>
                <textarea name="description" class="form-control">{{ user.description }}</textarea>
            </div>
            <div class="form-group">
                <label>–°—Ç–∞—Ç—É—Å:</label>
                <input type="text" name="status_text" class="form-control" value="{{ user.status_text }}" 
                       placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –û–Ω–ª–∞–π–Ω –∏ –≥–æ—Ç–æ–≤ –æ–±—â–∞—Ç—å—Å—è">
            </div>
            <button type="submit" class="btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </form>
        <a href="/profile" class="btn" style="margin-top: 10px; display: block; text-align: center;">
            <i class="fas fa-arrow-left"></i> –ù–∞–∑–∞–¥ –∫ –ø—Ä–æ—Ñ–∏–ª—é
        </a>
    </div>
    '''
    
    return render_template_string(BASE_TEMPLATE,
                                content=render_template_string(edit_template, user=user),
                                title='–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è',
                                theme=user.get('theme', 'dark'))

@app.route('/logout')
def logout():
    """–í—ã—Ö–æ–¥"""
    if 'user_id' in session:
        user_id = session['user_id']
        update_user_online(user_id, False)
        session.pop('user_id', None)
    
    return redirect('/')

# ==================== API –†–û–£–¢–´ ====================

@app.route('/api/user')
def api_get_user():
    """–ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ"""
    if 'user_id' not in session:
        return jsonify({'error': '–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω'}), 401
    
    user_id = session['user_id']
    user = get_user_by_id(user_id)
    
    if not user:
        return jsonify({'error': '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω'}), 404
    
    # –£–±–∏—Ä–∞–µ–º –ø–∞—Ä–æ–ª–∏ –∏–∑ –æ—Ç–≤–µ—Ç–∞
    user.pop('password1', None)
    user.pop('password2', None)
    
    return jsonify(user)

@app.route('/api/chat/<int:chat_id>/messages')
def api_get_messages(chat_id):
    """–ü–æ–ª—É—á–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π —á–∞—Ç–∞"""
    if 'user_id' not in session:
        return jsonify({'error': '–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω'}), 401
    
    user_id = session['user_id']
    db = get_db()
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø
    member = db.execute('SELECT * FROM chat_members WHERE chat_id = ? AND user_id = ?', 
                       (chat_id, user_id)).fetchone()
    if not member:
        db.close()
        return jsonify({'error': '–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω'}), 403
    
    # –ü–æ–ª—É—á–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è
    messages = db.execute('''
        SELECT m.*, 
               u.name as sender_name, 
               u.username as sender_username
        FROM messages m
        JOIN users u ON m.sender_id = u.id
        WHERE m.chat_id = ?
        ORDER BY m.timestamp DESC
        LIMIT 50
    ''', (chat_id,)).fetchall()
    
    db.close()
    
    return jsonify([dict(msg) for msg in messages])

@app.route('/api/chat/<int:chat_id>/send', methods=['POST'])
def api_send_message(chat_id):
    """–û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è"""
    if 'user_id' not in session:
        return jsonify({'error': '–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω'}), 401
    
    user_id = session['user_id']
    db = get_db()
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø
    member = db.execute('SELECT * FROM chat_members WHERE chat_id = ? AND user_id = ?', 
                       (chat_id, user_id)).fetchone()
    if not member:
        db.close()
        return jsonify({'error': '–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω'}), 403
    
    data = request.json
    text = data.get('text', '').strip()
    
    if not text:
        db.close()
        return jsonify({'error': '–°–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º'}), 400
    
    try:
        # –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
        cursor = db.execute('''
            INSERT INTO messages (chat_id, sender_id, text)
            VALUES (?, ?, ?)
        ''', (chat_id, user_id, text))
        
        message_id = cursor.lastrowid
        
        # –ü–æ–º–µ—á–∞–µ–º –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª–µ–º
        db.execute('INSERT OR IGNORE INTO message_reads (message_id, user_id) VALUES (?, ?)', 
                  (message_id, user_id))
        
        db.commit()
        
        # –ü–æ–ª—É—á–∞–µ–º –ø–æ–ª–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –æ—Ç–≤–µ—Ç–∞
        message = db.execute('''
            SELECT m.*, u.name as sender_name, u.username as sender_username
            FROM messages m
            JOIN users u ON m.sender_id = u.id
            WHERE m.id = ?
        ''', (message_id,)).fetchone()
        
        db.close()
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —á–µ—Ä–µ–∑ WebSocket
        socketio.emit('new_message', {
            'message': dict(message),
            'chat_id': chat_id
        }, room=f'chat_{chat_id}')
        
        return jsonify(dict(message))
        
    except Exception as e:
        db.rollback()
        db.close()
        return jsonify({'error': str(e)}), 500

@app.route('/api/message/<int:message_id>/react', methods=['POST'])
def api_react_message(message_id):
    """–†–µ–∞–∫—Ü–∏—è –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ"""
    if 'user_id' not in session:
        return jsonify({'error': '–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω'}), 401
    
    user_id = session['user_id']
    data = request.json
    reaction = data.get('reaction', '')
    
    if not reaction:
        return jsonify({'error': '–†–µ–∞–∫—Ü–∏—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞'}), 400
    
    db = get_db()
    
    try:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø –∫ —Å–æ–æ–±—â–µ–Ω–∏—é
        message = db.execute('SELECT chat_id FROM messages WHERE id = ?', (message_id,)).fetchone()
        if not message:
            db.close()
            return jsonify({'error': '–°–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ'}), 404
        
        member = db.execute('SELECT * FROM chat_members WHERE chat_id = ? AND user_id = ?', 
                           (message['chat_id'], user_id)).fetchone()
        if not member:
            db.close()
            return jsonify({'error': '–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω'}), 403
        
        # –î–æ–±–∞–≤–ª—è–µ–º –∏–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ–º —Ä–µ–∞–∫—Ü–∏—é
        db.execute('''
            INSERT OR REPLACE INTO message_reactions (message_id, user_id, reaction)
            VALUES (?, ?, ?)
        ''', (message_id, user_id, reaction))
        
        db.commit()
        db.close()
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —á–µ—Ä–µ–∑ WebSocket
        socketio.emit('message_reacted', {
            'message_id': message_id,
            'user_id': user_id,
            'reaction': reaction,
            'chat_id': message['chat_id']
        }, room=f'chat_{message["chat_id"]}')
        
        return jsonify({'success': True})
        
    except Exception as e:
        db.rollback()
        db.close()
        return jsonify({'error': str(e)}), 500

@app.route('/api/chat/<int:chat_id>/typing', methods=['POST'])
def api_typing(chat_id):
    """–ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –Ω–∞–±–æ—Ä–∞ —Ç–µ–∫—Å—Ç–∞"""
    if 'user_id' not in session:
        return jsonify({'error': '–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω'}), 401
    
    user_id = session['user_id']
    user = get_user_by_id(user_id)
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —á–µ—Ä–µ–∑ WebSocket
    socketio.emit('user_typing', {
        'user_id': user_id,
        'chat_id': chat_id,
        'user_name': user['name'] if user else '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'
    }, room=f'chat_{chat_id}')
    
    return jsonify({'success': True})

@app.route('/api/update_profile', methods=['POST'])
def api_update_profile():
    """–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è"""
    if 'user_id' not in session:
        return jsonify({'error': '–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω'}), 401
    
    user_id = session['user_id']
    name = request.form.get('name', '').strip()
    description = request.form.get('description', '').strip()
    status_text = request.form.get('status_text', '').strip()
    
    if not name:
        return jsonify({'error': '–ò–º—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ'}), 400
    
    db = get_db()
    
    try:
        db.execute('''
            UPDATE users 
            SET name = ?, description = ?, status_text = ?
            WHERE id = ?
        ''', (name, description, status_text, user_id))
        
        db.commit()
        db.close()
        
        return redirect('/profile')
        
    except Exception as e:
        db.rollback()
        db.close()
        return jsonify({'error': str(e)}), 500

# ==================== WebSocket –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò ====================

@socketio.on('connect')
def handle_connect():
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è"""
    if 'user_id' in session:
        user_id = session['user_id']
        update_user_online(user_id, True)

@socketio.on('disconnect')
def handle_disconnect():
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–∫–ª—é—á–µ–Ω–∏—è"""
    if 'user_id' in session:
        user_id = session['user_id']
        update_user_online(user_id, False)

@socketio.on('join_chat')
def handle_join_chat(data):
    """–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∫ –∫–æ–º–Ω–∞—Ç–µ —á–∞—Ç–∞"""
    chat_id = data.get('chat_id')
    user_id = session.get('user_id')
    
    if user_id and chat_id:
        join_room(f'chat_{chat_id}')

@socketio.on('leave_chat')
def handle_leave_chat(data):
    """–í—ã—Ö–æ–¥ –∏–∑ –∫–æ–º–Ω–∞—Ç—ã —á–∞—Ç–∞"""
    chat_id = data.get('chat_id')
    user_id = session.get('user_id')
    
    if user_id and chat_id:
        leave_room(f'chat_{chat_id}')

# ==================== –ó–ê–ü–£–°–ö –°–ï–†–í–ï–†–ê ====================

if __name__ == '__main__':
    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
    init_db()
    
    print("=" * 60)
    print("MonkeyGram Web –∑–∞–ø—É—â–µ–Ω!")
    print("=" * 60)
    print("–û—Ç–∫—Ä–æ–π—Ç–µ –≤ –±—Ä–∞—É–∑–µ—Ä–µ: http://localhost:5000")
    print("=" * 60)
    
    # –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞
    socketio.run(app, debug=True, host='0.0.0.0', port=5000, allow_unsafe_werkzeug=True)
